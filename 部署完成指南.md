# 部署完成指南

## ✅ 文件上传状态

**文件已成功上传到服务器！**

- 服务器: 38.175.195.104
- 远程路径: /var/www/maclock
- 上传时间: 刚刚完成

## 📋 下一步操作

### 方法一：使用 SSH 客户端（推荐）

1. **打开 PowerShell 或命令提示符**

2. **SSH 连接到服务器**：
   ```bash
   ssh root@38.175.195.104
   ```
   当提示输入密码时，输入: `0iHSn3CpCpDmlkub`

3. **进入项目目录**：
   ```bash
   cd /var/www/maclock
   ```

4. **执行部署脚本**：
   ```bash
   chmod +x deploy-complete.sh
   ./deploy-complete.sh
   ```

### 方法二：使用 WinSCP 终端

1. 打开 WinSCP
2. 连接到服务器（使用您已保存的会话 "hello1084"）
3. 点击菜单：**会话** → **在新终端中打开**
4. 在终端中执行：
   ```bash
   cd /var/www/maclock
   chmod +x deploy-complete.sh
   ./deploy-complete.sh
   ```

## 🚀 部署脚本将自动完成

部署脚本 (`deploy-complete.sh`) 会自动执行以下操作：

1. ✅ 安装 Node.js 20.x
2. ✅ 安装 PM2（进程管理器）
3. ✅ 安装 Docker 和 Docker Compose
4. ✅ 启动 PostgreSQL 数据库
5. ✅ 安装项目依赖 (npm install)
6. ✅ 生成 Prisma Client
7. ✅ 运行数据库迁移
8. ✅ 构建 Next.js 项目
9. ✅ 使用 PM2 启动应用服务

**预计时间**: 10-20 分钟（取决于服务器速度）

## ⚙️ 重要配置

### 环境变量配置

部署前，请确保创建 `.env.local` 文件：

```bash
cd /var/www/maclock
nano .env.local
```

添加以下环境变量：

```env
NODE_ENV=production
NEXT_PUBLIC_URL=http://38.175.195.104

# 数据库配置（使用 Docker Compose 中的 PostgreSQL）
DATABASE_URL=postgresql://maclock:maclock123@localhost:5432/maclock

# Stripe 配置（请替换为您的实际密钥）
STRIPE_SECRET_KEY=sk_live_...
NEXT_PUBLIC_STRIPE_PRICE_ID=price_...

# Clerk 配置（请替换为您的实际密钥）
CLERK_PUBLISHABLE_KEY=pk_live_...
CLERK_SECRET_KEY=sk_live_...
NEXT_PUBLIC_CLERK_SIGN_IN_URL=/login
NEXT_PUBLIC_CLERK_SIGN_UP_URL=/login
NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/
NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/

# 其他配置
RESEND_API_KEY=re_...
```

保存文件：按 `Ctrl+X`，然后 `Y`，然后 `Enter`

## 📊 部署后检查

### 1. 检查服务状态

```bash
# 检查 PM2 状态
pm2 status

# 查看应用日志
pm2 logs maclock

# 检查 Docker 容器
docker-compose ps
```

### 2. 检查应用是否运行

```bash
curl http://localhost:3000
```

### 3. 查看日志

```bash
# PM2 日志
pm2 logs maclock --lines 50

# 实时日志
pm2 logs maclock --lines 50 --raw
```

## 🔧 常用命令

### 重启应用
```bash
pm2 restart maclock
```

### 停止应用
```bash
pm2 stop maclock
```

### 查看资源使用
```bash
pm2 monit
```

### 更新代码后重新部署
```bash
cd /var/www/maclock
# 上传新文件后
npm install
npx prisma generate
npx prisma migrate deploy
npm run build
pm2 restart maclock
```

## 🌐 配置 Nginx（可选）

如果需要使用域名访问，可以配置 Nginx 反向代理：

1. 安装 Nginx：
   ```bash
   apt-get install -y nginx
   ```

2. 创建配置文件：
   ```bash
   nano /etc/nginx/sites-available/maclock
   ```

3. 复制 `nginx.conf.example` 的内容到配置文件

4. 启用站点：
   ```bash
   ln -s /etc/nginx/sites-available/maclock /etc/nginx/sites-enabled/
   nginx -t
   systemctl restart nginx
   ```

## 🔒 防火墙配置

确保端口已开放：

```bash
# 允许 HTTP
ufw allow 80/tcp

# 允许 HTTPS
ufw allow 443/tcp

# 如果直接访问 3000 端口
ufw allow 3000/tcp
```

## ❓ 故障排除

### 应用无法启动
1. 检查环境变量是否正确
2. 检查数据库是否运行：`docker-compose ps`
3. 查看 PM2 日志：`pm2 logs maclock`

### 数据库连接失败
1. 检查数据库容器：`docker-compose ps`
2. 检查 DATABASE_URL 环境变量
3. 测试连接：`docker-compose exec postgres psql -U maclock -d maclock`

### 构建失败
1. 检查 Node.js 版本：`node -v`（需要 18+）
2. 清理缓存：`rm -rf node_modules .next`
3. 重新安装：`npm install`

## 📞 需要帮助？

如果遇到问题，请检查：
- PM2 日志：`pm2 logs maclock`
- Next.js 构建日志
- 数据库连接状态
- 环境变量配置

---

**祝部署顺利！** 🎉






