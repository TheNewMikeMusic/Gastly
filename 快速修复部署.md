# 快速修复部署问题

## 问题：部署脚本卡在第一步

如果 `deploy-complete.sh` 卡在第一步（检查系统依赖），可能是以下原因：

1. **apt-get update 需要时间** - 这是正常的，可能需要几分钟
2. **需要用户确认** - 脚本可能在等待输入

## 解决方案

### 方法一：使用修复版本的脚本

我已经创建了修复版本的脚本 `deploy-complete-fixed.sh`，它：
- 添加了非交互式标志
- 添加了更多错误处理
- 添加了详细输出

**操作步骤：**

1. **上传修复版本的脚本**（如果需要）：
   ```bash
   # 在本地执行
   scp deploy-complete-fixed.sh root@38.175.195.104:/var/www/maclock/
   ```

2. **在服务器上执行修复版本**：
   ```bash
   cd /var/www/maclock
   chmod +x deploy-complete-fixed.sh
   ./deploy-complete-fixed.sh
   ```

### 方法二：手动执行步骤

如果脚本仍然卡住，可以手动执行每个步骤：

```bash
# 1. 更新系统（可能需要几分钟）
export DEBIAN_FRONTEND=noninteractive
apt-get update

# 2. 检查 Node.js
node -v
# 如果没有，安装：
curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
apt-get install -y nodejs

# 3. 检查 PM2
pm2 -v
# 如果没有，安装：
npm install -g pm2

# 4. 检查 Docker
docker --version
# 如果没有，安装：
curl -fsSL https://get.docker.com -o get-docker.sh
sh get-docker.sh
systemctl start docker

# 5. 启动数据库
cd /var/www/maclock
docker-compose up -d

# 6. 安装依赖
npm install

# 7. 生成 Prisma
npx prisma generate

# 8. 运行迁移
npx prisma migrate deploy

# 9. 构建项目
npm run build

# 10. 启动服务
pm2 start npm --name maclock -- start
pm2 save
```

### 方法三：检查当前状态

如果脚本卡住了，先检查：

```bash
# 查看进程
ps aux | grep deploy

# 查看是否有 apt-get 进程
ps aux | grep apt

# 如果 apt-get 正在运行，等待它完成
# 或者如果卡住了，可以终止：
# pkill apt-get
```

## 常见问题

### 1. apt-get update 很慢
这是正常的，特别是第一次更新。可以等待，或者：
```bash
# 使用国内镜像源（如果在中国）
# 编辑 /etc/apt/sources.list
```

### 2. 需要用户确认
添加非交互式标志：
```bash
export DEBIAN_FRONTEND=noninteractive
```

### 3. 权限问题
确保以 root 用户运行：
```bash
sudo su -
```

## 建议

如果脚本一直卡住，建议：

1. **等待 5-10 分钟** - apt-get update 可能需要时间
2. **检查网络连接** - 确保服务器可以访问外网
3. **查看详细输出** - 使用 `bash -x deploy-complete.sh` 查看详细执行过程
4. **分步执行** - 按照上面的手动步骤逐步执行

## 联系支持

如果问题持续，请提供：
- 卡在哪一步
- 错误信息（如果有）
- `ps aux` 的输出
- 网络连接状态






