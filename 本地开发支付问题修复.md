# 🔧 本地开发支付问题修复

## 问题描述

1. **跳转到服务器问题**：本地预览时，支付完成后跳转到服务器（`https://38.175.195.104`）而不是本地
2. **订单未创建问题**：支付完成后，服务器管理员后台没有新增订单详情

## 问题原因

### 1. 跳转到服务器
- `NEXT_PUBLIC_URL` 环境变量设置为服务器地址 `https://38.175.195.104`
- Stripe Checkout 的 `success_url` 使用了这个 URL，导致跳转到服务器

### 2. 订单未创建
- 本地数据库连接失败（`Authentication failed against database server at localhost`）
- 订单创建失败，但 Stripe session 创建成功
- Webhook 处理时，如果订单不存在就直接返回，不会创建订单

## 解决方案

### ✅ 1. 修复 URL 跳转问题

**修改文件**: `app/api/checkout/route.ts`

```typescript
// 在开发环境中，使用请求的 origin 作为 baseUrl，避免跳转到生产服务器
// 在生产环境中，使用配置的 NEXT_PUBLIC_URL
const isDevelopment = process.env.NODE_ENV === 'development'
const baseUrl = isDevelopment 
  ? (request.headers.get('origin') || 'http://localhost:3000')
  : (process.env.NEXT_PUBLIC_URL || 'http://localhost:3000')
```

**效果**：
- 开发环境：自动使用当前请求的 origin（如 `http://localhost:3001`）
- 生产环境：使用配置的 `NEXT_PUBLIC_URL`

### ✅ 2. 修复订单创建问题

**修改文件**: `lib/stripe-webhook.ts`

添加了 fallback 机制：如果订单不存在，从 Stripe Session 的 metadata 创建订单

```typescript
// 如果订单不存在，从 metadata 创建订单（fallback机制）
if (!order && session.metadata) {
  console.log(`Order not found for session ${session.id}, creating from metadata`)
  // 从 metadata 创建订单，包括所有收货信息
  order = await prisma.$transaction(async (tx) => {
    // 检查库存并创建订单
    // ...
  })
}
```

**效果**：
- 即使 checkout 时订单创建失败，webhook 也能从 metadata 创建订单
- 确保所有支付完成的订单都能被记录

## 📋 订单数据来源

订单信息现在有两个来源：

1. **主要来源**：Checkout 时创建（如果数据库连接正常）
2. **备用来源**：Webhook 时从 metadata 创建（如果 checkout 时创建失败）

所有收货信息都存储在：
- ✅ Stripe Session metadata（作为备份）
- ✅ 数据库 Order 表（主要存储）

## 🧪 测试步骤

### 本地开发测试

1. **启动本地服务器**
   ```bash
   npm run dev
   ```

2. **填写测试地址**
   ```
   Full Name: John Smith
   Phone: 5551234567
   Email: test@example.com
   Country: United States
   Address: 123 Main St
   State: CA
   City: San Francisco
   ZIP: 94102
   ```

3. **完成支付**
   - 使用 Stripe 测试卡：`4242 4242 4242 4242`
   - 支付完成后应该跳转回本地地址（如 `http://localhost:3001/success`）

4. **验证订单**
   - 检查服务器管理员后台是否有订单
   - 如果本地数据库连接失败，订单会在 webhook 中创建

### 生产环境测试

1. 确保 `NEXT_PUBLIC_URL` 设置为生产服务器地址
2. 确保数据库连接正常
3. 确保 Stripe Webhook 已配置并指向生产服务器

## ⚠️ 注意事项

### 本地开发环境

- **数据库连接**：本地开发时，如果数据库连接失败，订单会在 webhook 中创建
- **Webhook 配置**：本地开发时，需要使用 Stripe CLI 转发 webhook：
  ```bash
  stripe listen --forward-to localhost:3001/api/webhooks/stripe
  ```

### 生产环境

- **数据库连接**：确保生产环境数据库连接正常
- **Webhook 端点**：确保 Stripe Webhook 端点配置为生产服务器地址
- **环境变量**：确保 `NEXT_PUBLIC_URL` 设置为正确的生产地址

## 🔍 调试建议

如果订单仍然没有创建：

1. **检查 Stripe Webhook 日志**
   - 登录 Stripe Dashboard
   - 查看 Webhook 事件日志
   - 确认 `checkout.session.completed` 事件是否被接收

2. **检查服务器日志**
   - 查看服务器日志中的 webhook 处理信息
   - 查找 "Order not found" 或 "Order created from metadata" 消息

3. **检查数据库连接**
   - 确认生产环境数据库连接正常
   - 运行数据库检查脚本验证连接

4. **手动测试 Webhook**
   - 使用 Stripe CLI 发送测试 webhook
   - 检查订单是否创建

## ✅ 修复完成

- [x] URL 跳转问题已修复（开发环境自动使用本地地址）
- [x] 订单创建 fallback 机制已添加（webhook 中可以从 metadata 创建订单）
- [x] 所有收货信息都存储在 metadata 中（作为备份）

现在本地开发时，支付完成后会正确跳转回本地地址，订单也会在 webhook 中创建（即使 checkout 时创建失败）。


