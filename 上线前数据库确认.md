# ğŸš€ ä¸Šçº¿å‰æ•°æ®åº“ç¡®è®¤æ¸…å•

## âœ… è®¢å•å­˜å‚¨åŠŸèƒ½ç¡®è®¤

### è®¢å•åˆ›å»ºæµç¨‹ï¼ˆå·²å®ç°ï¼‰

1. **ç”¨æˆ·å¡«å†™æ”¶è´§ä¿¡æ¯** (`/checkout`)
   - æ”¶è´§äººå§“å (`shippingName`)
   - è”ç³»ç”µè¯ (`shippingPhone`)
   - é‚®ç®±åœ°å€ (`shippingEmail`)
   - è¯¦ç»†åœ°å€ (`shippingAddress`)
   - åŸå¸‚ (`shippingCity`)
   - å·/çœ (`shippingState`)
   - é‚®ç¼– (`shippingZip`)
   - å›½å®¶ (`shippingCountry`)

2. **åˆ›å»º Stripe Checkout Session**
   - æ‰€æœ‰æ”¶è´§ä¿¡æ¯å­˜å‚¨åœ¨ Stripe Session çš„ `metadata` ä¸­
   - åˆ›å»º Stripe Session ID ç”¨äºåç»­å…³è”

3. **åˆ›å»ºè®¢å•è®°å½•** (`app/api/checkout/route.ts:241-260`)
   ```typescript
   await tx.order.create({
     data: {
       userId: userId,
       amount: orderAmount,
       currency: 'usd',
       status: 'pending',
       stripeSessionId: session.id,
       couponCode: couponCode || null,
       discountAmount: discountAmount,
       reservedAt: new Date(),
       // æ‰€æœ‰æ”¶è´§ä¿¡æ¯
       shippingName: shippingData.name,
       shippingPhone: shippingData.phone,
       shippingEmail: shippingData.email,
       shippingAddress: shippingData.address,
       shippingCity: shippingData.city,
       shippingState: shippingData.state,
       shippingZip: shippingData.zip,
       shippingCountry: shippingData.country,
     },
   })
   ```

4. **æ”¯ä»˜å®Œæˆåæ›´æ–°è®¢å•** (`app/api/webhooks/stripe/route.ts`)
   - Webhook æ¥æ”¶ Stripe æ”¯ä»˜æˆåŠŸäº‹ä»¶
   - æ›´æ–°è®¢å•çŠ¶æ€ä¸º `paid`
   - æ‰£å‡åº“å­˜
   - å‘é€ç¡®è®¤é‚®ä»¶

### è®¢å•æ•°æ®å®Œæ•´æ€§ä¿è¯

âœ… **äº‹åŠ¡ä¿æŠ¤**: è®¢å•åˆ›å»ºå’Œåº“å­˜é¢„ç•™åœ¨åŒä¸€äº‹åŠ¡ä¸­
âœ… **åŒé‡å­˜å‚¨**: æ”¶è´§ä¿¡æ¯åŒæ—¶å­˜å‚¨åœ¨ï¼š
   - æ•°æ®åº“ Order è¡¨
   - Stripe Session metadataï¼ˆä½œä¸ºå¤‡ä»½ï¼‰

âœ… **é”™è¯¯å¤„ç†**: å¦‚æœæ•°æ®åº“æ“ä½œå¤±è´¥ï¼Œè®¢å•ä»å¯åœ¨ Webhook ä¸­åˆ›å»º

## ğŸ” æ•°æ®åº“æ£€æŸ¥æ­¥éª¤

### åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œæ£€æŸ¥

```bash
# SSH è¿æ¥åˆ°æœåŠ¡å™¨
ssh root@38.175.195.104

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /var/www/maclock

# è¿è¡Œæ•°æ®åº“æ£€æŸ¥è„šæœ¬
bash scripts/quick-db-check.sh

# æˆ–è€…ä½¿ç”¨ Prisma ç›´æ¥æ£€æŸ¥
npx prisma db pull
npx prisma generate
npx prisma migrate status
```

### æ‰‹åŠ¨éªŒè¯è®¢å•å­˜å‚¨

```bash
# 1. æ£€æŸ¥ Order è¡¨ç»“æ„
npx prisma db execute --stdin <<< "SELECT column_name FROM information_schema.columns WHERE table_name = 'Order';"

# 2. æ£€æŸ¥æ˜¯å¦æœ‰è®¢å•è®°å½•
npx prisma db execute --stdin <<< "SELECT id, userId, status, shippingName, shippingEmail FROM \"Order\" LIMIT 5;"

# 3. æµ‹è¯•åˆ›å»ºè®¢å•ï¼ˆä½¿ç”¨ Prisma Studioï¼‰
npx prisma studio
```

## ğŸ“‹ ä¸Šçº¿å‰å¿…é¡»ç¡®è®¤çš„äº‹é¡¹

### 1. æ•°æ®åº“é…ç½® âœ…
- [x] DATABASE_URL å·²æ­£ç¡®é…ç½®
- [ ] æ•°æ®åº“æœåŠ¡æ­£åœ¨è¿è¡Œ
- [ ] æ•°æ®åº“ç”¨æˆ·æœ‰è¶³å¤Ÿæƒé™
- [ ] æ‰€æœ‰è¿ç§»å·²åº”ç”¨ (`npx prisma migrate deploy`)

### 2. è¡¨ç»“æ„å®Œæ•´æ€§ âœ…
- [x] Order è¡¨å­˜åœ¨
- [x] æ‰€æœ‰å¿…éœ€å­—æ®µå­˜åœ¨ï¼ˆè§ schema.prismaï¼‰
- [x] ç´¢å¼•å·²åˆ›å»ºï¼ˆuserId, stripeSessionId, status ç­‰ï¼‰
- [x] å¤–é”®çº¦æŸæ­£ç¡®

### 3. è®¢å•å­˜å‚¨åŠŸèƒ½ âœ…
- [x] è®¢å•åˆ›å»ºä»£ç å·²å®ç°
- [x] æ”¶è´§ä¿¡æ¯å­—æ®µå®Œæ•´
- [x] äº‹åŠ¡ä¿æŠ¤å·²å®ç°
- [x] é”™è¯¯å¤„ç†å·²å®ç°
- [x] Webhook æ›´æ–°è®¢å•åŠŸèƒ½æ­£å¸¸

### 4. æµ‹è¯•éªŒè¯
- [ ] åˆ›å»ºæµ‹è¯•è®¢å•å¹¶éªŒè¯æ•°æ®å®Œæ•´æ€§
- [ ] éªŒè¯è®¢å•å¯ä»¥åœ¨åå°æŸ¥çœ‹
- [ ] éªŒè¯è®¢å•è¯¦æƒ…æ˜¾ç¤ºå®Œæ•´
- [ ] éªŒè¯æ”¯ä»˜åè®¢å•çŠ¶æ€æ›´æ–°

## ğŸ›¡ï¸ æ•°æ®å®‰å…¨ä¿è¯

1. **äº‹åŠ¡ä¿æŠ¤**: è®¢å•åˆ›å»ºå’Œåº“å­˜æ“ä½œåœ¨åŒä¸€äº‹åŠ¡ä¸­ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
2. **åŒé‡éªŒè¯**: 
   - åˆ›å»ºè®¢å•æ—¶æ£€æŸ¥åº“å­˜
   - Webhook ä¸­å†æ¬¡éªŒè¯æ”¯ä»˜çŠ¶æ€
3. **æ•°æ®å¤‡ä»½**: 
   - æ”¶è´§ä¿¡æ¯å­˜å‚¨åœ¨æ•°æ®åº“
   - åŒæ—¶å­˜å‚¨åœ¨ Stripe metadataï¼ˆå¯ä½œä¸ºå¤‡ä»½ï¼‰
4. **é”™è¯¯æ¢å¤**: 
   - å¦‚æœåˆ›å»ºè®¢å•å¤±è´¥ï¼ŒWebhook ä¸­å¯ä»¥é‡æ–°åˆ›å»º
   - ä½¿ç”¨ Stripe Session ID ä½œä¸ºå”¯ä¸€æ ‡è¯†

## ğŸ“Š è®¢å•æ•°æ®å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | æ˜¯å¦å¿…éœ€ |
|------|------|------|---------|
| id | String | è®¢å•å”¯ä¸€ID | âœ… |
| userId | String | ç”¨æˆ·IDï¼ˆClerkï¼‰ | âœ… |
| amount | Int | è®¢å•é‡‘é¢ï¼ˆåˆ†ï¼‰ | âœ… |
| status | String | è®¢å•çŠ¶æ€ | âœ… |
| stripeSessionId | String | Stripe Session ID | âœ… |
| shippingName | String | æ”¶è´§äººå§“å | âœ… |
| shippingPhone | String | è”ç³»ç”µè¯ | âœ… |
| shippingEmail | String | é‚®ç®±åœ°å€ | âœ… |
| shippingAddress | String | è¯¦ç»†åœ°å€ | âœ… |
| shippingCity | String | åŸå¸‚ | âœ… |
| shippingState | String | å·/çœ | âœ… |
| shippingZip | String | é‚®ç¼– | âœ… |
| shippingCountry | String | å›½å®¶ | âœ… |
| couponCode | String | ä¼˜æƒ åˆ¸ä»£ç  | âŒ |
| discountAmount | Int | æŠ˜æ‰£é‡‘é¢ | âŒ |

## ğŸš¨ ç´§æ€¥æƒ…å†µå¤„ç†

### å¦‚æœè®¢å•åˆ›å»ºå¤±è´¥

1. **æ£€æŸ¥æ—¥å¿—**: æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—æ‰¾å‡ºé”™è¯¯åŸå› 
2. **æ£€æŸ¥æ•°æ®åº“**: ç¡®è®¤æ•°æ®åº“è¿æ¥æ­£å¸¸
3. **æ£€æŸ¥åº“å­˜**: ç¡®è®¤äº§å“åº“å­˜å……è¶³
4. **æ‰‹åŠ¨åˆ›å»º**: å¦‚æœå¿…è¦ï¼Œå¯ä»¥ä» Stripe metadata æ‰‹åŠ¨åˆ›å»ºè®¢å•

### å¦‚æœè®¢å•æ•°æ®ä¸¢å¤±

1. **ä» Stripe æ¢å¤**: æ‰€æœ‰è®¢å•ä¿¡æ¯éƒ½å­˜å‚¨åœ¨ Stripe Session metadata
2. **ä»æ—¥å¿—æ¢å¤**: æ£€æŸ¥åº”ç”¨æ—¥å¿—ä¸­çš„è®¢å•åˆ›å»ºè®°å½•
3. **è”ç³»æ”¯æŒ**: å¦‚æœæ•°æ®å®Œå…¨ä¸¢å¤±ï¼Œè”ç³» Stripe æ”¯æŒè·å–è®¢å•ä¿¡æ¯

## âœ… æœ€ç»ˆç¡®è®¤

åœ¨æ­£å¼ä¸Šçº¿å‰ï¼Œè¯·ç¡®è®¤ï¼š

1. âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸
2. âœ… æ‰€æœ‰è¡¨ç»“æ„æ­£ç¡®
3. âœ… è®¢å•åˆ›å»ºåŠŸèƒ½æµ‹è¯•é€šè¿‡
4. âœ… Webhook æ¥æ”¶å’Œå¤„ç†æ­£å¸¸
5. âœ… åå°å¯ä»¥æŸ¥çœ‹è®¢å•
6. âœ… è®¢å•è¯¦æƒ…æ˜¾ç¤ºå®Œæ•´

**æ‰€æœ‰æ£€æŸ¥é€šè¿‡åï¼Œå¯ä»¥æ­£å¼ä¸Šçº¿ï¼** ğŸ‰


