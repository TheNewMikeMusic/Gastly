# 本地开发订单问题修复指南

## 问题描述
支付完成后，在 `/admin` 页面看不到新增的订单。

## 原因分析
1. **数据库连接失败**：本地 PostgreSQL 数据库连接失败
2. **订单创建失败**：checkout API 创建订单时数据库连接失败，订单未保存
3. **Webhook 无法处理**：Webhook 也需要数据库连接才能创建订单

## 解决方案

### 方案 1：修复本地数据库连接（推荐）

1. **检查 PostgreSQL 是否运行**
   ```bash
   # macOS
   brew services list | grep postgresql
   # 或
   pg_isready
   ```

2. **启动 PostgreSQL（如果未运行）**
   ```bash
   # macOS with Homebrew
   brew services start postgresql
   ```

3. **验证数据库连接**
   ```bash
   psql -h localhost -U maclock -d maclock -c "SELECT 1;"
   ```

4. **如果密码错误，更新 `.env.local`**
   ```env
   DATABASE_URL=postgresql://maclock:你的密码@localhost:5432/maclock
   ```

### 方案 2：手动创建订单（临时方案）

如果数据库暂时无法修复，可以使用脚本手动创建订单：

1. **列出最近的 Stripe Sessions**
   ```bash
   npx ts-node scripts/list-recent-sessions.ts
   ```

2. **从 Session 创建订单**
   ```bash
   npx ts-node scripts/manual-create-order-from-session.ts <session_id>
   ```

   例如：
   ```bash
   npx ts-node scripts/manual-create-order-from-session.ts cs_test_b1xtMNtKuhvgyfOMhStyLcEeYa7DzdV3VbHjBNBRZYNTwGCpgjcT9FeXAp
   ```

### 方案 3：使用生产数据库（仅用于测试）

如果生产数据库可用，可以临时修改 `.env.local` 使用生产数据库：

```env
DATABASE_URL=你的生产数据库URL
```

**⚠️ 警告**：不要在生产数据库上进行测试，可能会影响真实数据。

## 已找到的支付 Sessions

根据最近的检查，有以下已支付的 Sessions：

1. **Session ID**: `cs_test_b1xtMNtKuhvgyfOMhStyLcEeYa7DzdV3VbHjBNBRZYNTwGCpgjcT9FeXAp`
   - 金额: $99.00
   - 状态: paid
   - 客户邮箱: appleman7772953@gmail.com
   - 收货人: John Smith

2. **Session ID**: `cs_test_b1fvOK7R2I5ovfzL1hAmXlEsnUPy6pUtDvrkDNqzTsLSdd5OXH4hSzlxhu`
   - 金额: $99.00
   - 状态: paid
   - 客户邮箱: appleman7772953@gmail.com
   - 收货人: John Smith

## 验证订单创建

创建订单后，检查 admin 页面：
```bash
# 访问
http://localhost:3000/admin
```

或使用脚本检查：
```bash
npx ts-node scripts/check-database-production.ts
```

## 预防措施

1. **确保数据库服务运行**：在开发前检查 PostgreSQL 是否运行
2. **测试数据库连接**：在启动开发服务器前测试连接
3. **监控 Webhook**：检查 Stripe Dashboard 中的 Webhook 日志
4. **添加数据库连接检查**：在应用启动时检查数据库连接

## 相关文件

- `scripts/manual-create-order-from-session.ts` - 手动创建订单脚本
- `scripts/list-recent-sessions.ts` - 列出最近的 Sessions
- `lib/stripe-webhook.ts` - Webhook 处理逻辑
- `app/api/checkout/route.ts` - Checkout API


