# 部署说明 - 使用 sshpass

## 服务器信息
- **IP地址**: 38.175.195.104
- **用户名**: root
- **密码**: 0iHSn3CpCpDmlkub
- **部署路径**: /var/www/maclock

## 部署方式

### 方式一: 使用 bash 脚本 (推荐)

#### Windows 用户 (使用 WSL)
1. 打开 WSL 终端
2. 安装 sshpass (如果未安装):
   ```bash
   sudo apt-get update
   sudo apt-get install sshpass
   ```
3. 进入项目目录:
   ```bash
   cd /mnt/c/Users/apple/Documents/Maclock
   ```
4. 执行部署脚本:
   ```bash
   bash deploy-with-sshpass.sh
   ```

#### Windows 用户 (使用 Git Bash)
1. 打开 Git Bash
2. 安装 sshpass:
   - 下载: https://sourceforge.net/projects/sshpass/
   - 或使用包管理器安装
3. 进入项目目录:
   ```bash
   cd /c/Users/apple/Documents/Maclock
   ```
4. 执行部署脚本:
   ```bash
   bash deploy-with-sshpass.sh
   ```

#### Linux/macOS 用户
1. 安装 sshpass:
   ```bash
   # Ubuntu/Debian
   sudo apt-get install sshpass
   
   # macOS
   brew install hudochenkov/sshpass/sshpass
   ```
2. 进入项目目录
3. 执行部署脚本:
   ```bash
   bash deploy-with-sshpass.sh
   ```

### 方式二: 使用 PowerShell 脚本

在 PowerShell 中执行:
```powershell
.\deploy-with-sshpass.ps1
```

注意: PowerShell 脚本会自动检测并使用 WSL 或 Git Bash 来执行实际的部署。

## 部署流程

脚本会自动执行以下步骤:

1. ✅ 检查 sshpass 是否安装
2. ✅ 准备部署文件（排除 node_modules, .next 等）
3. ✅ 测试服务器连接
4. ✅ 创建服务器目录
5. ✅ 上传文件到服务器
6. ✅ 在服务器上安装依赖
7. ✅ 执行部署脚本（构建和重启服务）

## 手动部署 (如果脚本失败)

如果自动部署失败，可以手动执行以下步骤:

### 1. 上传文件
```bash
# 使用 sshpass 和 rsync
sshpass -p '0iHSn3CpCpDmlkub' rsync -avz --progress \
  -e "ssh -o StrictHostKeyChecking=no" \
  ./ root@38.175.195.104:/var/www/maclock/ \
  --exclude 'node_modules' \
  --exclude '.next' \
  --exclude '.git'

# 或使用 scp
sshpass -p '0iHSn3CpCpDmlkub' scp -r \
  -o StrictHostKeyChecking=no \
  ./ root@38.175.195.104:/var/www/maclock/
```

### 2. 连接到服务器并部署
```bash
sshpass -p '0iHSn3CpCpDmlkub' ssh -o StrictHostKeyChecking=no root@38.175.195.104
```

在服务器上执行:
```bash
cd /var/www/maclock
npm install
chmod +x deploy-complete.sh
./deploy-complete.sh
```

## 检查部署状态

部署完成后，检查服务状态:
```bash
sshpass -p '0iHSn3CpCpDmlkub' ssh -o StrictHostKeyChecking=no root@38.175.195.104 'pm2 status'
```

查看日志:
```bash
sshpass -p '0iHSn3CpCpDmlkub' ssh -o StrictHostKeyChecking=no root@38.175.195.104 'pm2 logs maclock --lines 50'
```

## 故障排除

### sshpass 未安装
- Ubuntu/Debian: `sudo apt-get install sshpass`
- macOS: `brew install hudochenkov/sshpass/sshpass`
- Windows: 使用 WSL 或 Git Bash

### 连接超时
- 检查服务器 IP 是否正确
- 检查网络连接
- 检查防火墙设置

### 权限错误
- 确保服务器目录存在: `/var/www/maclock`
- 确保有写入权限

### 构建失败
- 检查服务器上的 Node.js 版本 (需要 18+)
- 检查环境变量是否正确配置
- 查看构建日志: `pm2 logs maclock`

